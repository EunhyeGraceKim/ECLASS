<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="donation">

	<select id="donationList" resultType="com.spring.kimeh.model.DonStoryVO">
		select donseq, subject, content, listMainImg, storyImg, donCnt
		     , to_char(donDate,'yyyy-mm-dd hh24:mi:ss') as donDate 
		     , donDueDate , donStatus
			 , targetAmount, totalPayment, totalSupporter
   		from donStory   
   		order by donDate desc
	</select>
	
	<select id="donationStory" resultType="com.spring.kimeh.model.DonStoryVO" parameterType="String">
		select S.donseq, S.subject, S.content, S.listMainImg, S.storyImg, S.donDate, S.donDueDate,
      		   S.donStatus, S.targetAmount, S.totalPayment, S.totalSupporter, I.donImg, I.donImgseq,
     		   ceil(donDueDate - donDate) as dDay 
		from donStory S left join donImg I
		on S.donseq = I.fk_donSeq  
		where S.donseq = #{donseq}
	</select>
	
	    
    <!-- 1. 결제하기  -->
    <insert id="donationPayment" parameterType="com.spring.kimeh.model.DonPaymentVO">
    	insert into donPayment(fk_donSeq, fk_userid, name, noName, noDonpmt, paymentDate, payment, point) 
		values( #{fk_donSeq} , #{fk_userid} ,#{name}, default, default, default, #{payment}, default )
    </insert>
    
    <!-- 2. 포인트 차감 -->
    <update id="updateUsePoint" parameterType="com.spring.kimeh.model.DonPaymentVO">
    	update eclass_member set point = point - to_number(#{point})
		where userid = #{fk_userid}    
    </update>
    
    <!-- 3. AOP에서 사용하는 것으로 결제한 회원에게 포인트 증가  -->
    <update id="pointPlus" parameterType="HashMap">
    	update mymvc_shopping_member set point = point + to_number(#{pointPlus})
		where userid = #{userid}
    </update>
    
    
    
    

</mapper>